<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz Profile</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    /* ðŸŒŒ General Reset */
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between; /* pushes leaderboard to bottom */
      background: url('https://wallpapers.com/images/hd/profile-background-vgrf672q1g5l9e0t.jpg') center/cover no-repeat fixed;
      color: white;
      font-family: sans-serif;
      overflow-x: hidden;
    }

    .main-content {
      padding: 2vh;
      width: 100%;
    }

    /* ðŸ”¹ Leaderboard Button */
    #lead {
      position: relative;
      font-size: 8vh;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 4px;
      border: 4px solid #00ffff;
      border-radius: 1vh;
      background: linear-gradient(90deg, #ff00cc, #00ffff, #ff9900);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
      cursor: pointer;
      text-align: center;
      box-shadow: 0 0 10px #00ffff;
      transition: all 0.3s ease;
      margin: 0 auto 3vh auto; /* centered horizontally, 3vh from bottom */
      display: block;
    }
    #lead:hover {
      box-shadow: 0 0 20px #00ffff, 0 0 40px #ff00cc;
      transform: scale(1.05);
    }

    /* ðŸ”¹ Overview Section */
    .ov {
      font-size: 10vh;
      text-align: center;
      margin-top: 5vh;
    }

    .present {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 2vh;
      align-items: center;
      justify-items: start;
      font-size: 5vh;
      margin: 5vh auto;
      width: 90%;
      max-width: 1200px;
      background: rgba(0,0,0,0.4);
      padding: 2vh;
      border-radius: 2vh;
    }

    .present > p, .present > div {
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }

    /* ðŸ”¹ Profile Section */
    .Profile {
      font-size: 10vh;
      text-align: center;
      margin: 5vh 0 2vh 0;
    }

    .profilebox {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5vh;
      margin: 0 auto 5vh auto;
      width: 90%;
      max-width: 800px;
      font-size: 5vh;
      background: rgba(0,0,0,0.4);
      padding: 2vh;
      border-radius: 2vh;
    }

    .profilebox > p, .profilebox > div {
      margin: 0;
      display: flex;
      align-items: center;
    }

    /* ðŸ”¹ Gradient Text for #lead */
    .gradient-text {
      background: linear-gradient(90deg, #ff00cc, #00ffff, #ff9900);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 
        0 0 10px rgba(255, 0, 255, 0.6),
        0 0 20px rgba(0, 255, 255, 0.6),
        0 0 30px rgba(255, 255, 0, 0.6);
      animation: neonGradient 5s linear infinite;
    }

    @keyframes neonGradient {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }

    /* ðŸ”¹ Mobile Layout */
    @media (max-width: 700px) {

  html, body {
    overflow-x: hidden;     /* prevent right-side overflow */
  }

  /* Titles smaller */
  .ov, .Profile {
    font-size: 3rem;        /* instead of 5rem / 10vh */
    text-align: center;
  }

  /* Overview box full width */
  .present {
    grid-template-columns: 1fr;
    width: 70%;
    margin: 2vh auto;
    font-size: 1.6rem;       /* smaller text */
    padding: 2vh;
  }

  /* Profile box full width */
  .profilebox {
    grid-template-columns: 1fr;
    width: 70%;
    margin: 2vh auto 5vh;
    font-size: 1.6rem;
    padding: 2vh;
  }

  /* Leaderboard button */
  #lead {
    font-size: 2.2rem;       /* way more reasonable */
    width: 90%;              /* fits on any phone */
    margin: 2vh auto;
    letter-spacing: 2px;
    padding: 1.5vh;
  }
}
  </style>
</head>
<body>
  <!-- ðŸ“„ Main content (Overview + Profile) -->
  <div class="main-content">
    <div class="ov">Overview of Quiz</div>
    <div class="present">
      <p>Total score</p><div></div>
      <p>Correct</p><div></div>
      <p>Incorrect</p><div></div>
      <p>Unanswered</p><div></div>
    </div>

    <div class="Profile">Profile</div>
    <div class="profilebox">
      <p>Username</p><div><span id="username">Loading...</span></div>
      <p>Score</p><div><span id="score">Loading...</span></div>
      <p>Questions attempted vs unanswered</p><div><span id="attemptedVsUnanswered">-</span></div>
      <p>Easy</p><div><span id="easy">-</span></div>
      <p>Moderate</p><div><span id="moderate">-</span></div>
      <p>Hard</p><div><span id="hard">-</span></div>
      <p>Correct Vs Wrong</p><div><span id="correctWrong">-</span></div>
    </div>
  </div>

  <!-- ðŸ† Leaderboard button at bottom -->
  <button id="lead" class="gradient-text" onclick="leader()">Leaderboard</button>

  <!-- âœ… Only one script runs after the library is fully loaded -->
  <script>
    window.supabase = supabase.createClient(
  'https://ztnldcowmuhldurztvad.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0bmxkY293bXVobGR1cnp0dmFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODE0OTksImV4cCI6MjA3MDA1NzQ5OX0.6U_BxibjiCK6p1xMgFyCd1nokaCUoetU_qWwEQ_YkQE'
);

  /*async function updateAndDisplayProfile() {
    const localScore = Number(localStorage.getItem("score") || 0);
    const correct = Number(localStorage.getItem("correct") || 0);
    const incorrect = Number(localStorage.getItem("incorrect") || 0);
    const unanswered = Number(localStorage.getItem("unanswered") || 0);
    const attempted = correct + incorrect;

    try {
      const { data: { user }, error: authError } = await window.supabase.auth.getUser();
      if (authError || !user) {
        console.error("âŒ Not logged in:", authError?.message);
        return;
      }

      const { data: profile, error: profileError } = await window.supabase
        .from("profiles")
        .select("username, score")
        .eq("id", user.id)
        .single();

      if (profileError) {
        console.error("âŒ Profile fetch error:", profileError.message);
        return;
      }

      let updatedScore = profile.score;

      if (localScore > 0) {
        updatedScore += localScore;

        const { error: updateError } = await window.supabase
          .from("profiles")
          .update({ score: updatedScore })
          .eq("id", user.id);

        if (updateError) {
          console.error("âŒ Failed to update score:", updateError.message);
          return;
        }

        localStorage.setItem("score", "0");
      }

      document.getElementById("username").textContent = profile.username;
      document.getElementById("score").textContent = updatedScore;
      document.getElementById("attempted").textContent = attempted;
      document.getElementById("correctWrong").textContent = `${correct} / ${incorrect}`;
      document.getElementById("unansweredProfile").textContent = unanswered;
    } catch (e) {
      console.error("âŒ Unexpected error:", e.message);
    }
  }*/
 async function updateAndDisplayProfile() {
  const localScore = Number(localStorage.getItem("score") || 0);

  try {
    const { data: { user }, error: authError } = await window.supabase.auth.getUser();
    if (authError || !user) {
      console.error("âŒ Not logged in:", authError?.message);
      return;
    }

    const { data: profile, error: profileError } = await window.supabase
      .from("profiles")
      .select(`
  username,
  score,
  easy_correct,
  easy_incorrect,
  moderate_correct,
  moderate_incorrect,
  hard_correct,
  hard_incorrect,
  attempted,
  unattempted
`)

      .eq("id", user.id)
      .single();

    if (profileError) {
      console.error("âŒ Profile fetch error:", profileError.message);
      return;
    }

    let updatedScore = Number(profile.score || 0);

    if (localScore > 0) {
      updatedScore += localScore;

      const { error: updateError } = await window.supabase
        .from("profiles")
        .update({ score: updatedScore })
        .eq("id", user.id);

      if (updateError) {
        console.error("âŒ Failed to update score:", updateError.message);
        return;
      }

      localStorage.setItem("score", "0");
    }

    // ðŸ§  Compute values
    const easy_correct = Number(profile.easy_correct || 0);
    const easy_incorrect = Number(profile.easy_incorrect || 0);
    const moderate_correct = Number(profile.moderate_correct || 0);
    const moderate_incorrect = Number(profile.moderate_incorrect || 0);
    const hard_correct = Number(profile.hard_correct || 0);
    const hard_incorrect = Number(profile.hard_incorrect || 0);
    const unanswered = Number(profile.unattempted || 0);

    const totalCorrect = easy_correct + moderate_correct + hard_correct;
    const totalIncorrect = easy_incorrect + moderate_incorrect + hard_incorrect;
    const totalAttempted = Number(profile.attempted || 0);

    // ðŸ§© DOM Updates
    document.getElementById("username").textContent = profile.username;
    document.getElementById("score").textContent = updatedScore;
    document.getElementById("correctWrong").textContent = `${totalCorrect} / ${totalIncorrect}`;
    document.getElementById("attemptedVsUnanswered").textContent = `${totalAttempted} / ${unanswered}`;
    document.getElementById("easy").textContent = `${easy_correct} / ${easy_incorrect}`;
    document.getElementById("moderate").textContent = `${moderate_correct} / ${moderate_incorrect}`;
    document.getElementById("hard").textContent = `${hard_correct} / ${hard_incorrect}`;
  } catch (e) {
    console.error("âŒ Unexpected error:", e.message);
  }
}


  async function fetchDetailedStatsAndRenderCharts() {
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if (authError || !user) {
    console.error("Not logged in");
    return;
  }

  const { data: profile, error: profileError } = await supabase
    .from("profiles")
    .select(`
      easy_correct, easy_incorrect,
      moderate_correct, moderate_incorrect,
      hard_correct, hard_incorrect
    `)
    .eq("id", user.id)
    .single();

  if (profileError) {
    console.error("Failed to fetch difficulty stats:", profileError.message);
    return;
  }

  // ðŸŸ¢ Update HTML numbers
  document.getElementById("easy").textContent = `${profile.easy_correct} / ${profile.easy_incorrect}`;
  document.getElementById("moderate").textContent = `${profile.moderate_correct} / ${profile.moderate_incorrect}`;
  document.getElementById("hard").textContent = `${profile.hard_correct} / ${profile.hard_incorrect}`;

  const totalCorrect = profile.easy_correct + profile.moderate_correct + profile.hard_correct;
  const totalIncorrect = profile.easy_incorrect + profile.moderate_incorrect + profile.hard_incorrect;
  const unanswered = Number(localStorage.getItem("unanswered") || 0);
  const answered = totalCorrect + totalIncorrect;

  // ðŸŸ¢ Create Pie Charts
  renderPieChart("overallChart", ["Correct", "Incorrect"], [totalCorrect, totalIncorrect]);
  renderPieChart("difficultyChart", ["Easy", "Moderate", "Hard"], [
    profile.easy_correct + profile.easy_incorrect,
    profile.moderate_correct + profile.moderate_incorrect,
    profile.hard_correct + profile.hard_incorrect
  ]);
  renderPieChart("answeredChart", ["Answered", "Unanswered"], [answered, unanswered]);
}

function renderPieChart(canvasId, labels, data) {
  const ctx = document.getElementById(canvasId).getContext("2d");
  new Chart(ctx, {
    type: "pie",
    data: {
      labels,
      datasets: [{
        label: "Quiz Stats",
        data,
        backgroundColor: ["#4caf50", "#f44336", "#ff9800"],
      }],
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: "white"
          }
        }
      }
    }
  });
}

  function fillOverview() {
    const presentDivs = document.querySelectorAll(".present > div");
    const keys = ["score", "correct", "incorrect", "unanswered"];

    keys.forEach((key, i) => {
      const value = localStorage.getItem(key);
      presentDivs[i].textContent = value !== null ? value : "N/A";
    });
  }
  window.addEventListener("DOMContentLoaded", async () => {
  fillOverview();
  await updateAndDisplayProfile();
  await fetchDetailedStatsAndRenderCharts(); // ðŸŸ¢ Add this line
});
function leader() {
  window.location.href = "dogfood.html";
}
</script>

</body>
</html>
